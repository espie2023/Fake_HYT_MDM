<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Device Dashboard</title>
    <link rel="stylesheet" href="/static/style.css">
    <!-- æ­¤AKç»‘å®šmdm.infiniteplayground.ccéƒ¨ç½²æ‚¨è‡ªå·±çš„ç½‘ç«™éœ€è¦è‡ªè¡Œæ›´æ¢AK -->
    {% if map_type == "baidu" %}
        <script type="text/javascript" src="https://api.map.baidu.com/api?v=3.0&ak=ykBhwdrkLQkHba6HRTAzBPOMoL8Ce06O"></script>
    {% endif %}
</head>
<body>

    <!-- ç™»å½•çŠ¶æ€æŒ‰é’® -->
    <div class="map-toggle" style="position: absolute; top: 25px; right: 300px; z-index: 10;">
        {% if logged_in_user %}
            <a href="/admin/dashboard" style="background-color: #007acc; color: white; padding: 6px 12px; border-radius: 6px; text-decoration: none; font-weight: bold; margin-right: 8px;">
                {{ logged_in_user }}
            </a>
            <a href="/admin/logout" style="background-color: #dc3545; color: white; padding: 6px 12px; border-radius: 6px; text-decoration: none; font-weight: bold;">
                ç™»å‡º
            </a>
        {% else %}
            <a href="/admin/login" style="background-color: #ccc; color: #333; padding: 6px 12px; border-radius: 6px; text-decoration: none; font-weight: bold;">
                ç™»å½•
            </a>
        {% endif %}
    </div>

    <!-- å³ä¸Šè§’äºŒç»´ç -->
    <a href="/" title="ç‚¹å‡»è¿”å›é¦–é¡µ">
        <div id="dashboard-qrcode" style="position: absolute; top: 5px; right: 5px; width: 70px; height: 70px; cursor: pointer; z-index: 10;"></div>
    </a>

    <div class="map-toggle" style="position: absolute; top: 5px; right: 80px; z-index: 10;">
        <a class="map-button {% if map_type == 'baidu' %}active{% else %}inactive{% endif %}" 
           href="/dashboard?map=baidu{% if request.query_params.get('filter_device') %}&filter_device={{ request.query_params.get('filter_device') }}{% endif %}">
            ç™¾åº¦åœ°å›¾
        </a>
        <a class="map-button {% if map_type == 'openstreet' %}active{% else %}inactive{% endif %}" 
           href="/dashboard?map=openstreet{% if request.query_params.get('filter_device') %}&filter_device={{ request.query_params.get('filter_device') }}{% endif  %}">
            OpenStreet
        </a>
    </div>

<div class="dashboard-header">
    <h1>Registered Devices (Updated in 5 Days)</h1>
    <form method="get" action="/dashboard" class="device-filter-form-inline">
        <input type="hidden" name="map" value="{{ map_type }}">
        <label for="filter_device">ç­›é€‰è®¾å¤‡:</label>
        <select name="filter_device" onchange="this.form.submit()">
            <option value="">-- æ˜¾ç¤ºå…¨éƒ¨ --</option>
            {% for device_id, entry in devices_all.items() %}
                {% if entry.update_time is defined and entry.deviceInfo is defined and (now - entry.update_time) <= 432000 %}
                    {% set alias = entry.deviceInfo.wholeInfo.alias if entry.deviceInfo and entry.deviceInfo.wholeInfo and entry.deviceInfo.wholeInfo.alias else device_id %}
                    <option value="{{ device_id }}" {% if device_id == request.query_params.get('filter_device') %}selected{% endif %}>
                        {{ alias }}
                    </option>
                {% endif %}
            {% endfor %}
        </select>
    </form>
</div>

    {% if request.query_params.get('filter_device') %}
    <!-- å•è®¾å¤‡ä¸¤åˆ—å±•ç¤º -->
    <div class="device-detail-grid">
        {% set device_id = request.query_params.get('filter_device') %}
        {% set entry = devices.get(device_id) %}
        {% if entry and (now - entry.update_time) <= 432000 %}
        <div class="device-info">
            <!-- è®¾å¤‡ä¿¡æ¯å¡ç‰‡ -->
            <h2>
                {% if logged_in_user %}
                <a href="/device?deviceid={{ device_id }}" style="text-decoration: none; color: inherit;">
                    {{ entry.get('deviceInfo', {}).get('wholeInfo', {}).get('alias', device_id) }}
                </a>
                {% else %}
                    {{ entry.get('deviceInfo', {}).get('wholeInfo', {}).get('alias', device_id) }}
                {% endif %}
            </h2>

            {% set last_update = now - entry.update_time %}
            <p>
                <strong>Last Update:</strong>
                <span style="background-color: {{ 'green' if last_update <= 600 else 'red' }}; color: white; font-weight: bold; padding: 2px 6px; border-radius: 4px;">
                    {{ last_update }}s ago â€” {{ 'Online' if last_update <= 600 else 'Offline' }}
                </span>
            </p>

            {% set whole = entry.get('deviceInfo', {}).get("wholeInfo", {}) %}
            {% if whole.modelName %}<p><strong>Model:</strong> {{ whole.modelName }}</p>{% endif %}

            {% if logged_in_user %}
            <!-- å·²ç™»å½•ç”¨æˆ·ï¼šæ˜¾ç¤ºå®Œæ•´ä¿¡æ¯ -->
            <!-- æŒ‰é’®åŒº -->
            <span style="display:inline-flex; gap:8px; align-items:center; margin-top: 10px;">
              <!-- æŸ¥çœ‹åŸå§‹ JSON -->
              <a href="/device?deviceid={{ device_id }}"
                 target="_blank"
                 style="display:inline-block; padding:4px 8px; border-radius:4px; background:#6c757d; color:#fff; text-decoration:none;">
                 æŸ¥çœ‹åŸå§‹ JSON
              </a>

              {% if device_id not in allowed_devices %}
                <!-- å·²ç™»å½•ä½†ä¸åœ¨è‡ªå·±åä¸‹ï¼šæ˜¾ç¤ºæ³¨å†ŒæŒ‰é’® -->
                <a href="/admin/device_register?device_id={{ device_id }}"
                   style="display:inline-block; padding:4px 8px; border-radius:4px; background:#198754; color:#fff; text-decoration:none;">
                   æ³¨å†Œæ­¤è®¾å¤‡åˆ°æˆ‘çš„è´¦æˆ·
                </a>
              {% endif %}
            </span>

            <p><strong>Device ID:</strong> {{ device_id }}</p>
            <p><strong>Version:</strong> {{ entry.versionCode or "N/A" }}</p>
            {% set bb = entry.get('deviceInfo', {}).get("bbInfo", {}) %}
            {% if bb.androidVersion %}<p><strong>Android:</strong> {{ bb.androidVersion }}</p>{% endif %}
            {% if bb.cpuModel %}<p><strong>CPU:</strong> {{ bb.cpuModel }}</p>{% endif %}
            {% if bb.ip %}<p><strong>IP:</strong> {{ bb.ip }}</p>{% endif %}
            {% if bb.mac %}<p><strong>MAC:</strong> {{ bb.mac }}</p>{% endif %}
            {% if bb.ramUsage and bb.ramTotal %}
            <div class="bar-group">
                <label>RAM Usage ({{ bb.ramUsage }} / {{ bb.ramTotal }} MB)</label>
                <progress value="{{ bb.ramUsage }}" max="{{ bb.ramTotal }}"></progress>
            </div>
            {% endif %}
            {% if bb.romUsage and bb.romTotal %}
            <div class="bar-group">
                <label>ROM Usage ({{ bb.romUsage }} / {{ bb.romTotal }} MB)</label>
                <progress value="{{ bb.romUsage }}" max="{{ bb.romTotal }}"></progress>
            </div>
            {% endif %}
            {% if whole.batteryHealth %}
            <div class="bar-group">
                <label>
                    Battery Level ({{ whole.batteryLevel }}%)
                    {% if whole.batteryStatus == 5 %}
                        <span style="background-color: green; color: white; font-weight: bold; padding: 2px 6px; border-radius: 4px;">FULL</span>
                    {% elif whole.batteryStatus == 4 %}
                        Charging-4
                    {% elif whole.batteryStatus == 3 %}
                        <span style="background-color: skyblue; color: white; font-weight: bold; padding: 2px 6px; border-radius: 4px;">Battery in Use</span>
                    {% elif whole.batteryStatus == 2 %}
                        <span style="background-color: lightgreen; color: white; font-weight: bold; padding: 2px 6px; border-radius: 4px;">Charging</span>
                    {% else %}
                        STATUS {{ whole.batteryStatus }}
                    {% endif %}
                </label>
                <progress value="{{ whole.batteryLevel }}" max="100"></progress>
            </div>
            <p>
                <strong>Battery Cycle:</strong>
                <span style="color: green; font-weight: bold;">{{ whole.batteryChargeTimes }}</span>
                <strong>Battery Health:</strong>
                <span style="color: {{ 'red' if whole.batteryHealth < 80 else 'green' }}; font-weight: bold;">
                    {{ whole.batteryHealth }}%
                </span>
            </p>
            {% endif %}
            {% if bb.signalLevel %}<p><strong>4G Signal:</strong> {{ bb.signalLevel }} dBm</p>{% endif %}
            {% if entry.location %}
            <p>
                <strong>Location:</strong> {{ entry.location.latitude }}, {{ entry.location.longitude }}<br>
                <strong>Last Location Update:</strong> {{ now - entry.location.update_time }}s ago<br>
                <a href="https://www.google.com/maps?q={{ entry.location.latitude }},{{ entry.location.longitude }}" target="_blank">
                    <strong>View on Google Maps</strong>
                </a>
            </p>
            <p>
                APRS SSID:
                <a href="https://aprs.fi/#!call=a%2F{{ entry.location.aprs_ssid }}" target="_blank">
                    <strong>{{ entry.location.aprs_ssid }}</strong>
                </a>
                <a href="/change_aprs_ssid?device_id={{ device_id }}" style="margin-left: 10px;"><button type="button">Change APRS SSID</button></a>
            </p>
            {% endif %}
            {% else %}
            <!-- æœªç™»å½•ç”¨æˆ·ï¼šä»…æ˜¾ç¤ºåŸºæœ¬ä¿¡æ¯ï¼Œå¹¶æç¤ºç™»å½• -->
            <div style="background-color: #fff3cd; border: 1px solid #ffc107; border-radius: 8px; padding: 15px; margin-top: 15px;">
                <p style="color: #856404; margin: 0;">
                    <strong>âš ï¸ æ›´å¤šè¯¦ç»†ä¿¡æ¯éœ€è¦ç™»å½•åæŸ¥çœ‹</strong><br>
                    <span style="font-size: 14px;">ç™»å½•åå¯æŸ¥çœ‹è®¾å¤‡å®Œæ•´ä¿¡æ¯ã€GPSä½ç½®ã€ç”µæ± çŠ¶æ€ç­‰è¯¦ç»†æ•°æ®</span>
                </p>
            </div>
            {% endif %}
        </div>
        <div class="device-map">
            <!--Biadu Map-->
            {% if logged_in_user and entry.location %}
                {% if map_type == "baidu" %}
                    {% set lat = entry.location.latitude | float %}
                    {% set lon = entry.location.longitude | float %}
                    {% set alias = entry.deviceInfo.wholeInfo.alias if entry.deviceInfo and entry.deviceInfo.wholeInfo else device_id %}

                    <div id="bdmap_device" style="width: 100%; height: 700px; border: 1px solid #ccc; border-radius: 8px;"></div>

                    <script type="text/javascript">
                    (function() {
                        const wgsLat = {{ lat }};
                        const wgsLon = {{ lon }};
                        const alias = "{{ alias }}";

                        const map = new BMap.Map("bdmap_device");
                        map.enableScrollWheelZoom(true);

                        // åŸå§‹ WGS84 ç‚¹
                        const wgsPoint = new BMap.Point(wgsLon, wgsLat);

                        // è°ƒç”¨åæ ‡è½¬æ¢å™¨
                        const convertor = new BMap.Convertor();
                        convertor.translate([wgsPoint], 1, 5, function(data) {
                            if (data.status === 0) {
                                const bdPoint = data.points[0];
                                map.centerAndZoom(bdPoint, 15);

                                const marker = new BMap.Marker(bdPoint);
                                map.addOverlay(marker);

                                const infoContent = `<b>${alias}</b><br/>åŸå§‹åæ ‡ (WGS-84):<br/>çº¬åº¦: ${wgsLat}<br/>ç»åº¦: ${wgsLon}`;
                                const infoWindow = new BMap.InfoWindow(infoContent);

                                marker.addEventListener("click", function() {
                                    map.openInfoWindow(infoWindow, bdPoint);
                                });
                            } else {
                                console.error("åæ ‡è½¬æ¢å¤±è´¥", data);
                            }
                        });
                    })();
                    </script>
                {% elif map_type == "openstreet" %}
                    <!--OpenStreetMap-->
                    {% set lat = entry.location.latitude | float %}
                    {% set lon = entry.location.longitude | float %}
                    {% set dx = 0.1 %}
                    {% set dy = 0.1 %}
                    <iframe
                        width="100%" height="700" frameborder="0" scrolling="no" marginheight="0" marginwidth="0"
                        style="border: 1px solid #ccc; border-radius: 8px;"
                        src="https://www.openstreetmap.org/export/embed.html?bbox={{ lon - dx }}%2C{{ lat - dy }}%2C{{ lon + dx }}%2C{{ lat + dy }}&layer=mapnik&marker={{ lat      }}%2C{{ lon }}">
                    </iframe>
                    <br>
                    <small>
                        <a href="https://www.openstreetmap.org/?mlat={{ lat }}&mlon={{ lon }}#map=15/{{ lat }}/{{ lon }}" target="_blank">
                            åœ¨ OpenStreetMap ä¸ŠæŸ¥çœ‹å¤§å›¾
                        </a>
                    </small>
                {% endif %}
            {% elif not logged_in_user %}
                <!-- æœªç™»å½•ç”¨æˆ·ä¸æ˜¾ç¤ºåœ°å›¾ -->
                <div style="width: 100%; height: 700px; border: 1px solid #ccc; border-radius: 8px; display: flex; align-items: center; justify-content: center; background-color: #f8f9fa;">
                    <div style="text-align: center; color: #6c757d;">
                        <h3>ğŸ”’ åœ°å›¾å’Œä½ç½®ä¿¡æ¯</h3>
                        <p>ç™»å½•åå¯æŸ¥çœ‹è®¾å¤‡å®æ—¶ä½ç½®å’Œåœ°å›¾</p>
                        <a href="/admin/login" style="display: inline-block; margin-top: 10px; padding: 10px 20px; background-color: #007acc; color: white; text-decoration: none; border-radius: 6px; font-weight: bold;">
                            ç«‹å³ç™»å½•
                        </a>
                    </div>
                </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
    {% else %}
    <!-- å¤šè®¾å¤‡å¡ç‰‡ -->
    <div class="device-grid">
        {% for device_id, entry in devices.items() if (now - entry.update_time) <= 172800 %}
        {% if entry.deviceInfo %}
        <div class="device-card">
            <!-- æ ‡é¢˜è¶…é“¾æ¥ -->
            <h2>
                <a href="/dashboard?filter_device={{ device_id }}&map={{ map_type }}"
                   style="text-decoration: none; color: inherit;">
                    {{ entry.get('deviceInfo', {}).get('wholeInfo', {}).get('alias', device_id) }}
                </a>
            </h2>

            <!-- ä¸ŠæŠ¥æ—¶é—´ -->
            {% set last_update = now - entry.update_time %}
            <p>
                <strong>Last Update:</strong>
                <span style="background-color: {{ 'green' if last_update <= 600 else 'red' }}; color: white; font-weight: bold; padding: 2px 6px; border-radius: 4px;">
                    {{ last_update }}s ago â€” {{ 'Online' if last_update <= 600 else 'Offline' }}
                </span>
            </p>

            {% set bb = entry.get('deviceInfo', {}).get("bbInfo", {}) %}
            {% set whole = entry.get('deviceInfo', {}).get("wholeInfo", {}) %}

            {% if whole.modelName %}<p><strong>Model:</strong> {{ whole.modelName }}</p>{% endif %}

            {% if logged_in_user %}
            <!-- å·²ç™»å½•ç”¨æˆ·ï¼šæ˜¾ç¤ºå®Œæ•´ä¿¡æ¯ -->
            <p><strong>Device ID:</strong> {{ device_id }}</p>
            <p><strong>Version:</strong> {{ entry.versionCode or "N/A" }}</p>
            {% if bb.androidVersion %}<p><strong>Android:</strong> {{ bb.androidVersion }}</p>{% endif %}
            {% if bb.cpuModel %}<p><strong>CPU:</strong> {{ bb.cpuModel }}</p>{% endif %}
            {% if bb.ip %}<p><strong>IP:</strong> {{ bb.ip }}</p>{% endif %}
            {% if bb.mac %}<p><strong>MAC:</strong> {{ bb.mac }}</p>{% endif %}

            {% if bb.ramUsage and bb.ramTotal %}
            <div class="bar-group">
                <label>RAM Usage ({{ bb.ramUsage }} / {{ bb.ramTotal }} MB)</label>
                <progress value="{{ bb.ramUsage }}" max="{{ bb.ramTotal }}"></progress>
            </div>
            {% endif %}

            {% if bb.romUsage and bb.romTotal %}
            <div class="bar-group">
                <label>ROM Usage ({{ bb.romUsage }} / {{ bb.romTotal }} MB)</label>
                <progress value="{{ bb.romUsage }}" max="{{ bb.romTotal }}"></progress>
            </div>
            {% endif %}

            {% if whole.batteryHealth %}
            <div class="bar-group">
                <label>
                    Battery Level ({{ whole.batteryLevel }}%)
                    {% if whole.batteryStatus == 5 %}
                        <span style="background-color: green; color: white; font-weight: bold; padding: 2px 6px; border-radius: 4px;">FULL</span>
                    {% elif whole.batteryStatus == 4 %}
                        Charging-4
                    {% elif whole.batteryStatus == 3 %}
                        <span style="background-color: skyblue; color: white; font-weight: bold; padding: 2px 6px; border-radius: 4px;">Battery in Use</span>
                    {% elif whole.batteryStatus == 2 %}
                        <span style="background-color: lightgreen; color: white; font-weight: bold; padding: 2px 6px; border-radius: 4px;">Charging</span>
                    {% else %}
                        STATUS {{ whole.batteryStatus }}
                    {% endif %}
                </label>
                <progress value="{{ whole.batteryLevel }}" max="100"></progress>
            </div>

            <p>
                <strong>Battery Cycle:</strong>
                <span style="color: green; font-weight: bold;">{{ whole.batteryChargeTimes }}</span>

                <strong>Battery Health:</strong>
                <span style="color: {{ 'red' if whole.batteryHealth < 80 else 'green' }}; font-weight: bold;">
                    {{ whole.batteryHealth }}%
                </span>
            </p>
            {% endif %}

            {% if bb.signalLevel %}<p><strong>4G Signal:</strong> {{ bb.signalLevel }} dBm</p>{% endif %}

            {% if entry.location %}
            <p>
                <strong>Location:</strong> {{ entry.location.latitude }}, {{ entry.location.longitude }}<br>
                <strong>Last Location Update:</strong> {{ now - entry.location.update_time }}s ago<br>
                <a href="https://www.google.com/maps?q={{ entry.location.latitude }},{{ entry.location.longitude }}" target="_blank">
                    <strong>View on Google Maps</strong>
                </a><br>
            <p>
              APRS SSID:
              <a href="https://aprs.fi/#!call=a%2F{{ entry.location.aprs_ssid }}" target="_blank">
                <strong>{{ entry.location.aprs_ssid }}</strong>
              </a>

              {% if device_id %}
                <a href="/change_aprs_ssid?device_id={{ device_id }}" style="margin-left: 10px;">
                  <button type="button">Change APRS SSID</button>
                </a>
              {% endif %}
            </p>
            </p>
            {% if map_type == "baidu" %}
                {% set lat = entry.location.latitude | float %}
                {% set lon = entry.location.longitude | float %}
                {% set alias = entry.deviceInfo.wholeInfo.alias if entry.deviceInfo and entry.deviceInfo.wholeInfo else device_id %}
                
                <div id="bdmap_{{ loop.index }}" style="width: 100%; height: 300px; border: 1px solid #ccc; border-radius: 8px;"></div>
                
                <script type="text/javascript">
                (function() {
                    const wgsLat = {{ lat }};
                    const wgsLon = {{ lon }};
                    const alias = "{{ alias }}";
                
                    const map = new BMap.Map("bdmap_{{ loop.index }}");
                    map.enableScrollWheelZoom(true);
                
                    // åŸå§‹ WGS84 ç‚¹
                    const wgsPoint = new BMap.Point(wgsLon, wgsLat);
                
                    // è°ƒç”¨åæ ‡è½¬æ¢å™¨
                    const convertor = new BMap.Convertor();
                    convertor.translate([wgsPoint], 1, 5, function(data) {
                        if (data.status === 0) {
                            const bdPoint = data.points[0];
                            map.centerAndZoom(bdPoint, 15);
                
                            const marker = new BMap.Marker(bdPoint);
                            map.addOverlay(marker);
                
                            const infoContent = `<b>${alias}</b><br/>åŸå§‹åæ ‡ (WGS-84):<br/>çº¬åº¦: ${wgsLat}<br/>ç»åº¦: ${wgsLon}`;
                            const infoWindow = new BMap.InfoWindow(infoContent);
                
                            marker.addEventListener("click", function() {
                                map.openInfoWindow(infoWindow, bdPoint);
                            });
                        } else {
                            console.error("åæ ‡è½¬æ¢å¤±è´¥", data);
                        }
                    });
                })();
                </script>
            {% elif map_type == "openstreet" %}
                <!--OpenStreetMap-->
                {% set lat = entry.location.latitude | float %}
                {% set lon = entry.location.longitude | float %}
                {% set dx = 5 %}
                {% set dy = 5 %}
                <iframe
                    width="100%" height="300" frameborder="0" scrolling="no" marginheight="0" marginwidth="0"
                    style="border: 1px solid #ccc; border-radius: 8px;"
                    src="https://www.openstreetmap.org/export/embed.html?bbox={{ lon - dx }}%2C{{ lat - dy }}%2C{{ lon + dx }}%2C{{ lat + dy }}&layer=mapnik&marker={{ lat }}%2C    {{ lon }}">
                </iframe>
                
    
                <br>
                <small>
                    <a href="https://www.openstreetmap.org/?mlat={{ lat }}&mlon={{ lon }}#map=15/{{ lat }}/{{ lon }}" target="_blank">
                        åœ¨ OpenStreetMap ä¸ŠæŸ¥çœ‹å¤§å›¾
                    </a>
                </small>
            {% endif %}
            {% endif %}
            {% else %}
            <!-- æœªç™»å½•ç”¨æˆ·ï¼šæ˜¾ç¤ºæç¤ºä¿¡æ¯ -->
            <div style="background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 12px; margin-top: 10px; text-align: center;">
                <p style="color: #6c757d; margin: 0; font-size: 14px;">
                    ğŸ”’ <strong>ç™»å½•åæŸ¥çœ‹æ›´å¤šä¿¡æ¯</strong><br>
                    <span style="font-size: 12px;">åŒ…æ‹¬GPSä½ç½®ã€åœ°å›¾ã€è¯¦ç»†ç¡¬ä»¶ä¿¡æ¯ç­‰</span>
                </p>
            </div>
            {% endif %}
        </div>
        {% endif %}
        {% endfor %}
    </div>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const ip = "{{ server_ip }}";
        const port = "{{ server_port }}";
        const text = `IP:${ip};Port:${port}`;
    
        new QRCode(document.getElementById("dashboard-qrcode"), {
            text: text,
            width: 70,
            height: 70
        });
    });
    </script>
</body>
</html>